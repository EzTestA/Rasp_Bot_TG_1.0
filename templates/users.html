<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 20px; padding: 0 10px; }
        .logout-buttons { 
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .logout-buttons button, .logout-buttons a { 
            margin: 5px;
            padding: 8px 12px;
        }
        .nav-tabs { margin-bottom: 15px; overflow-x: auto; flex-wrap: nowrap; }
        .nav-tabs .nav-link { white-space: nowrap; }
        .table-container { max-height: 65vh; overflow-y: auto; }
        .table th { position: sticky; top: 0; background: white; }
        .text-danger { color: #dc3545 !important; }
        .text-success { color: #28a745 !important; }
        .btn-sm { 
            padding: 0.4rem 0.6rem;
            font-size: 0.9rem;
            margin: 2px;
        }
        h1 { font-size: 1.8rem; margin-bottom: 15px; }
        .card-header h5 { font-size: 1.2rem; }
        
        @media (max-width: 576px) {
            .table td, .table th {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            .btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
            .container {
                margin-top: 10px;
                padding: 0 5px;
            }
            .logout-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</h1>
        
        <div class="logout-buttons">
            <button onclick="restartBot()" class="btn btn-warning mr-2">
                <i class="fas fa-sync-alt"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
            </button>
            <button onclick="shutdownSystem()" class="btn btn-danger mr-2">
                <i class="fas fa-power-off"></i> –í—ã–∫–ª—é—á–∏—Ç—å
            </button>
            <a href="/logout" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </a>
        </div>

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/logs">
                    <i class="fas fa-terminal"></i> –õ–æ–≥–∏
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/users">
                    <i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/schedule">
                    <i class="fas fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                </a>
            </li>
        </ul>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    <button onclick="loadUsers()" class="btn btn-sm btn-primary float-right">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <button class="btn btn-success mb-3" data-toggle="modal" data-target="#sendMessageModal">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                    
                    <table class="table table-striped table-bordered mb-0">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="4" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal fade" id="sendMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
                    <select id="messageRecipient" class="form-control">
                        <option value="">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                    <textarea id="messageText" class="form-control" rows="5" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function loadUsers() {
    $('#usersTableBody').html('<tr><td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>');
    
    $.get('/get_users')
        .done(function(data) {
            let tableContent = '';
            let recipientOptions = '<option value="">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>'; // –ë–∞–∑–æ–≤–∞—è –æ–ø—Ü–∏—è

            for (const [userId, userData] of Object.entries(data)) {
                const isBanned = userData.banned || false;
                const notifications = userData.notifications || false;
                
                tableContent += `
                <tr>
                    <td>${userId}</td>
                    <td>${userData.username || 'N/A'}</td>
                    <td class="${isBanned ? 'text-danger' : 'text-success'}">
                        ${isBanned ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}
                        ${isBanned ? '<br><small>' + (userData.ban_reason || '') + '</small>' : ''}
                    </td>
                    <td class="${notifications ? 'text-success' : 'text-danger'}">
                        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${notifications ? '‚úÖ –í–∫–ª.' : '‚ùå –í—ã–∫–ª.'}
                    </td>
                    <td>
                        ${isBanned ? 
                            `<button onclick="unbanUser('${userId}')" class="btn btn-sm btn-success">
                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            </button>` :
                            `<button onclick="banUser('${userId}')" class="btn btn-sm btn-danger">
                                –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            </button>`
                        }
                    </td>
                </tr>`;

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                recipientOptions += `
                    <option value="${userId}">
                        ${userId} (${userData.username || 'N/A'})
                    </option>`;
            }

            $('#usersTableBody').html(tableContent);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            $('#messageRecipient').html(recipientOptions);
        })
        .fail(function() {
            $('#usersTableBody').html('<tr><td colspan="5" class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>');
        });
}

        function sendMessage() {
    const recipient = $('#messageRecipient').val();
    const text = $('#messageText').val().trim();

    if (!text) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!');
        return;
    }

    $.post('/send_message', {
        user_id: recipient,
        message: text
    })
    .done(function(data) {
        alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ' + data.message);
        $('#sendMessageModal').modal('hide');
    })
    .fail(function(xhr) {
        alert('–û—à–∏–±–∫–∞: ' + (xhr.responseJSON?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
}


        function banUser(userId) {
            const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:", "–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª");
            if (reason !== null) {
                $.post('/ban_user', { user_id: userId, reason: reason })
                    .done(function (data) {
                        alert(data.message);
                        loadUsers();
                    })
                    .fail(function (xhr) {
                        alert('–û—à–∏–±–∫–∞: ' + (xhr.responseJSON?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    });
            }
        }

       function restartBot() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞?')) return;
            
            fetch('/restart_bot')
                .then(response => response.json())
                .then(data => alert(data.message))
                .catch(error => alert('–û—à–∏–±–∫–∞: ' + error));
        }

function shutdownSystem() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫–ª—é—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É (–±–æ—Ç + –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)?')) return;

    fetch('/shutdown', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç');
        }
        return response.json();
    })
    .then(data => {
        alert(data.message);
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
        setTimeout(() => {
            window.location.href = '/';
            setTimeout(() => window.close(), 500);
        }, 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–°–∏—Å—Ç–µ–º–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É...');
        setTimeout(() => window.close(), 1000);
    });
}

        function unbanUser(userId) {
            if (confirm(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) {
                $.post('/unban_user', { user_id: userId })
                    .done(function (data) {
                        alert(data.message);
                        loadUsers();
                    })
                    .fail(function (xhr) {
                        alert('–û—à–∏–±–∫–∞: ' + (xhr.responseJSON?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    });
            }
        }

        $(document).ready(function() {
            loadUsers();
            setInterval(loadUsers, 30000);
        });
    </script>
</body>
</html>
