<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 20px;
            padding: 0 10px;
        }

        .logout-buttons {
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .logout-buttons button, .logout-buttons a {
            margin: 5px;
            padding: 8px 12px;
        }

        .nav-tabs {
            margin-bottom: 15px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .nav-tabs .nav-link {
            white-space: nowrap;
        }

        .table-container {
            max-height: 65vh;
            overflow-y: auto;
        }

        .table th {
            position: sticky;
            top: 0;
            background: white;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .text-success {
            color: #28a745 !important;
        }

        .btn-sm {
            padding: 0.4rem 0.6rem;
            font-size: 0.9rem;
            margin: 2px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .card-header h5 {
            font-size: 1.2rem;
        }

        .actions-modal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .action-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .action-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .message-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }

        .message-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .recipients-info {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .recipients-info ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .recipients-info li {
            margin-bottom: 4px;
        }

        @media (max-width: 576px) {
            .table td, .table th {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }

            .container {
                margin-top: 10px;
                padding: 0 5px;
            }

            .logout-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</h1>

        <div class="logout-buttons">
            <button onclick="restartBot()" class="btn btn-warning mr-2">
                <i class="fas fa-sync-alt"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
            </button>
            <button onclick="shutdownSystem()" class="btn btn-danger mr-2">
                <i class="fas fa-power-off"></i> –í—ã–∫–ª—é—á–∏—Ç—å
            </button>
            <a href="/logout" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </a>
        </div>

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/logs">
                    <i class="fas fa-terminal"></i> –õ–æ–≥–∏
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/users">
                    <i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/schedule">
                    <i class="fas fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                </a>
            </li>
        </ul>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    <div class="float-right">
                        <button onclick="loadUsers()" class="btn btn-sm btn-primary mr-2">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-sm btn-info" onclick="loadMessageType('all')" data-toggle="modal" data-target="#messageHistoryModal">
                            <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
                        </button>
                    </div>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <div class="p-3">
                        <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#sendMessageModal">
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                        </button>
                    </div>

                    <table class="table table-striped table-bordered mb-0">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</th>
                                <th>–í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                <th>–í—ã–±—Ä–∞—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal fade" id="sendMessageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</label>
                        <select id="messageType" class="form-control" onchange="updateRecipientFields()">
                            <option value="all">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                            <option value="selected">–í—ã–±—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                            <option value="single">–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</option>
                        </select>
                    </div>
                    
                    <div id="userSelectionContainer" style="display:none;">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</label>
                        <div id="userSelection" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                    
                    <div id="singleUserContainer" style="display:none;">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <select id="singleUserSelect" class="form-control">
                            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                        </select>
                    </div>
                    
                    <div class="form-group mt-3">
                        <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                        <textarea id="messageText" class="form-control" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="modal fade" id="messageHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="loadMessageType('all')">–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadMessageType('broadcast')">–í—Å–µ–º</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadMessageType('individual')">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadMessageType('group')">–ì—Ä—É–ø–ø–æ–≤—ã–µ</a>
                        </li>
                    </ul>
                    <div id="messagesContent" class="mt-3" style="max-height: 60vh; overflow-y: auto;">
                        <div class="text-center py-4">
                            <i class="fas fa-info-circle"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal fade actions-modal" id="userActionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span id="actionsUsername"></span></h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="userActionsContent">
                        <p class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function loadUsers() {
            $('#usersTableBody').html('<tr><td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>');

            $.get('/get_users')
                .done(function (data) {
                    let tableContent = '';
                    let recipientOptions = '';

                    for (const [userId, userData] of Object.entries(data)) {
                        const isBanned = userData.banned || false;
                        const notifications = userData.notifications || false;
                        const totalActions = userData.total_actions || 0;

                        tableContent += `
                            <tr>
                                <td>${userId}</td>
                                <td>${userData.username || 'N/A'}</td>
                                <td class="${isBanned ? 'text-danger' : 'text-success'}">
                                    ${isBanned ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}
                                    ${isBanned ? '<br><small>' + (userData.ban_reason || '') + '</small>' : ''}
                                </td>
                                <td class="${notifications ? 'text-success' : 'text-danger'}">
                                    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${notifications ? '‚úÖ –í–∫–ª.' : '‚ùå –í—ã–∫–ª.'}
                                </td>
                                <td>
                                    <button onclick="showUserActions('${userId}', '${userData.username || 'N/A'}')"
                                            class="btn btn-sm btn-info">
                                        ${totalActions} <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                                <td>
                                    ${isBanned ?
                                    `<button onclick="unbanUser('${userId}')" class="btn btn-sm btn-success">
                                        –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                    </button>` :
                                    `<button onclick="banUser('${userId}')" class="btn btn-sm btn-danger">
                                        –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                    </button>`}
                                </td>
                                <td>
                                    <button onclick="selectUser('${userId}')" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </td>
                            </tr>`;

                        recipientOptions += `<option value="${userId}">${userId} (${userData.username || 'N/A'})</option>`;
                    }

                    $('#usersTableBody').html(tableContent);
                    $('#singleUserSelect').html(recipientOptions);
                })
                .fail(function () {
                    $('#usersTableBody').html('<tr><td colspan="7" class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>');
                });
        }

        function updateRecipientFields() {
            const type = $('#messageType').val();
            $('#userSelectionContainer').toggle(type === 'selected');
            $('#singleUserContainer').toggle(type === 'single');
            
            if (type === 'selected' || type === 'single') {
                loadUsersForSelection();
            }
        }

        function loadUsersForSelection() {
            const container = $('#messageType').val() === 'selected' 
                ? 'userSelection' 
                : 'singleUserSelect';
            
            $('#' + container).html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>');
            
            $.get('/get_users')
                .done(function(data) {
                    let content = '';
                    for (const [userId, userData] of Object.entries(data)) {
                        const displayName = `${userId} (${userData.username || 'N/A'})` + 
                                          (userData.banned ? ' [–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù]' : '');
                        
                        if (container === 'userSelection') {
                            content += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${userId}" id="user-${userId}">
                                <label class="form-check-label" for="user-${userId}">
                                    ${displayName}
                                </label>
                            </div>`;
                        } else {
                            content += `<option value="${userId}">${displayName}</option>`;
                        }
                    }
                    $('#' + container).html(content);
                })
                .fail(function() {
                    $('#' + container).html('<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>');
                });
        }

        function sendMessage() {
            const messageType = $('#messageType').val();
            const messageText = $('#messageText').val().trim();
            
            if (!messageText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!');
                return;
            }
            
            let user_ids = [];
            let message_type = '';
            
            switch(messageType) {
                case 'all':
                    message_type = 'broadcast';
                    break;
                case 'selected':
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    $('#userSelection input:checked').each(function() {
                        user_ids.push($(this).val());
                    });
                    if (user_ids.length === 0) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
                        return;
                    }
                    message_type = 'group';
                    break;
                case 'single':
                    const userId = $('#singleUserSelect').val();
                    if (!userId) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
                        return;
                    }
                    user_ids = [userId];
                    message_type = 'individual';
                    break;
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            $('#sendMessageModal .modal-footer').html(`
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">–û—Ç–ø—Ä–∞–≤–∫–∞...</span>
                </div>
            `);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ FormData
            const formData = new FormData();
            formData.append('message', messageText);
            formData.append('message_type', message_type);
            
            // –î–æ–±–∞–≤–ª—è–µ–º user_ids —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ broadcast
            if (message_type !== 'broadcast') {
                user_ids.forEach(id => {
                    formData.append('user_ids[]', id);
                });
            }
            
            $.ajax({
                url: '/send_message',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    alert(data.message);
                    $('#sendMessageModal').modal('hide');
                    $('#messageText').val('');
                },
                error: function(xhr) {
                    alert('–û—à–∏–±–∫–∞: ' + (xhr.responseJSON?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                },
                complete: function() {
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
                    $('#sendMessageModal .modal-footer').html(`
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    `);
                }
            });
        }

        function loadMessageType(messageType) {
            $('#messagesContent').html('<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>');
            
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            $.get('/get_users')
                .then(function(usersData) {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π endpoint –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                    const endpoint = messageType === 'all' ? '/get_all_messages' : `/get_messages/${messageType}`;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    $.get(endpoint)
                        .done(function(data) {
                            if (data.messages && data.messages.length > 0) {
                                let html = '<div class="list-group">';
                                
                                data.messages.forEach(msg => {
                                    const date = new Date(msg.timestamp).toLocaleString();
                                    const currentMessageType = messageType === 'all' ? msg.type : messageType;
                                    let recipientsInfo = '';
                                    
                                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
                                    if (msg.recipients === 'all') {
                                        recipientsInfo = '<div class="recipients-info"><strong>–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</strong></div>';
                                    } else {
                                        // –î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                                        const recipients = Array.isArray(msg.recipients) ? msg.recipients : [msg.recipients];
                                        
                                        recipientsInfo = '<div class="recipients-info">';
                                        recipientsInfo += `<strong>${recipients.length > 1 ? '–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:' : '–ü–æ–ª—É—á–∞—Ç–µ–ª—å:'}</strong>`;
                                        recipientsInfo += '<ul>';
                                        
                                        recipients.forEach(userId => {
                                            const user = usersData[userId];
                                            recipientsInfo += `
                                                <li>
                                                    ${userId} - ${user ? (user.username || 'N/A') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                                                </li>`;
                                        });
                                        
                                        recipientsInfo += '</ul></div>';
                                    }
                                    
                                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                                    let stats = '';
                                    if (msg.delivered && msg.delivered.length > 0) {
                                        const success = msg.delivered.filter(d => d.status === 'success').length;
                                        const failed = msg.delivered.filter(d => d.status === 'failed').length;
                                        stats = `<small class="text-muted">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${success}, –û—à–∏–±–æ–∫: ${failed}</small>`;
                                    }
                                    
                                    html += `
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">${currentMessageType === 'broadcast' ? 'üì¢ –†–∞—Å—Å—ã–ª–∫–∞' : 
                                              currentMessageType === 'group' ? 'üë• –ì—Ä—É–ø–ø–∞' : 'üë§ –õ–∏—á–Ω–æ–µ'}</h6>
                                            <small>${date}</small>
                                        </div>
                                        <p class="mb-1">${msg.message}</p>
                                        ${recipientsInfo}
                                        ${stats ? `<div class="mt-2">${stats}</div>` : ''}
                                    </div>`;
                                });
                                
                                html += '</div>';
                                $('#messagesContent').html(html);
                            } else {
                                $('#messagesContent').html(`<p class="text-center">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–∏–ø–∞ "${messageType}"</p>`);
                            }
                        })
                        .fail(function() {
                            $('#messagesContent').html('<p class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>');
                        });
                })
                .fail(function() {
                    $('#messagesContent').html('<p class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>');
                });
        }

        function selectUser(userId) {
            $(`#user-${userId}`).prop('checked', true);
            $('#messageType').val('selected');
            updateRecipientFields();
            $('#sendMessageModal').modal('show');
        }

        function showUserActions(userId, username) {
            $('#actionsUsername').text(username);
            $('#userActionsContent').html('<p class="text-center"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π...</p>');
            $('#userActionsModal').modal('show');

            $.get(`/get_user_actions/${userId}`)
                .done(function (data) {
                    let actionsHtml = '';

                    if (data.actions && data.actions.length > 0) {
                        actionsHtml += `<div class="alert alert-info">
                                –í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π: ${data.total_actions}
                            </div>`;

                        data.actions.forEach(action => {
                            const actionTime = new Date(action.time).toLocaleString();
                            let actionText = '';

                            switch (action.action) {
                                case 'start': actionText = '–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (/start)'; break;
                                case 'schedule_request': actionText = '–ó–∞–ø—Ä–æ—Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è'; break;
                                case 'bot_info': actionText = '–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ'; break;
                                case 'notifications_on': actionText = '–í–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π'; break;
                                case 'notifications_off': actionText = '–í—ã–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π'; break;
                                default: actionText = action.action;
                            }

                            actionsHtml += `
                                <div class="action-item">
                                    <div class="action-text">${actionText}</div>
                                    <div class="action-time">${actionTime}</div>
                                </div>`;
                        });
                    } else {
                        actionsHtml = '<p class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ–π—Å—Ç–≤–∏—è—Ö</p>';
                    }

                    $('#userActionsContent').html(actionsHtml);
                })
                .fail(function () {
                    $('#userActionsContent').html('<p class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π</p>');
                });
        }

        function banUser(userId) {
            const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:", "–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª");
            if (reason !== null) {
                $.post('/ban_user', { user_id: userId, reason: reason })
                    .done(function (data) {
                        alert(data.message);
                        loadUsers();
                    })
                    .fail(function (xhr) {
                        alert('–û—à–∏–±–∫–∞: ' + (xhr.responseJSON?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    });
            }
        }

        function unbanUser(userId) {
            if (confirm(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) {
                $.post('/unban_user', { user_id: userId })
                    .done(function (data) {
                        alert(data.message);
                        loadUsers();
                    })
                    .fail(function (xhr) {
                        alert('–û—à–∏–±–∫–∞: ' + (xhr.responseJSON?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    });
            }
        }

        function restartBot() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞?')) return;

            fetch('/restart_bot')
                .then(response => response.json())
                .then(data => alert(data.message))
                .catch(error => alert('–û—à–∏–±–∫–∞: ' + error));
        }

        function shutdownSystem() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫–ª—é—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É (–±–æ—Ç + –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)?')) return;

            fetch('/shutdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    setTimeout(() => {
                        window.location.href = '/';
                        setTimeout(() => window.close(), 500);
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–°–∏—Å—Ç–µ–º–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É...');
                    setTimeout(() => window.close(), 1000);
                });
        }

        $(document).ready(function () {
            loadUsers();
            setInterval(loadUsers, 30000);
        });
    </script>
</body>
</html>